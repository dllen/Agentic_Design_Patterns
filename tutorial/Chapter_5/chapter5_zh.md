# ç¬¬5ç« ï¼šå·¥å…·ä½¿ç”¨ (Tool Use)

## æ¨¡å¼æ¦‚è¿°
å·¥å…·ä½¿ç”¨ï¼ˆTool Useï¼‰æ˜¯æ™ºèƒ½ä»£ç†ç³»ç»Ÿä¸­çš„ä¸€ä¸ªå…³é”®è®¾è®¡æ¨¡å¼ï¼Œå®ƒå…è®¸ä»£ç†ä¸å¤–éƒ¨ç³»ç»Ÿã€APIã€æ•°æ®åº“æˆ–å…¶ä»–è½¯ä»¶ç»„ä»¶è¿›è¡Œäº¤äº’ã€‚è¿™ç§æ¨¡å¼æ‰©å±•äº†ä»£ç†çš„èƒ½åŠ›ï¼Œä½¿å…¶èƒ½å¤Ÿè¶…è¶Šå…¶å†…éƒ¨è®­ç»ƒæ•°æ®å’Œå›ºæœ‰èƒ½åŠ›ï¼Œé€šè¿‡è°ƒç”¨å¤–éƒ¨å·¥å…·æ¥æ‰§è¡Œç‰¹å®šä»»åŠ¡ã€è·å–å®æ—¶ä¿¡æ¯æˆ–æ‰§è¡Œå¤æ‚æ“ä½œã€‚

å·¥å…·ä½¿ç”¨æ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†ä¸“ä¸šåŠŸèƒ½å°è£…åœ¨å·¥å…·ä¸­ï¼Œä»£ç†å¯ä»¥ç†è§£å’Œè°ƒç”¨è¿™äº›å·¥å…·æ¥å®Œæˆè¶…å‡ºå…¶åŸç”Ÿèƒ½åŠ›èŒƒå›´çš„ä»»åŠ¡ã€‚è¿™ä½¿ä»£ç†èƒ½å¤Ÿæ‰§è¡Œä»ç®€å•çš„ä¿¡æ¯æ£€ç´¢åˆ°å¤æ‚çš„å¤šæ­¥éª¤æ“ä½œç­‰å„ç§ä»»åŠ¡ã€‚

é€šè¿‡å®æ–½å·¥å…·ä½¿ç”¨ï¼Œä»£ç†å¯ä»¥è®¿é—®å¤§é‡å¤–éƒ¨ä¿¡æ¯å’ŒåŠŸèƒ½ï¼Œæ˜¾è‘—å¢å¼ºå…¶é—®é¢˜è§£å†³èƒ½åŠ›å’Œå®ç”¨æ€§ã€‚è¿™ç§æ¨¡å¼å¯¹äºéœ€è¦æœ€æ–°æ•°æ®ã€ä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’æˆ–æ‰§è¡Œä¸“ä¸šä»»åŠ¡çš„åº”ç”¨ç‰¹åˆ«æœ‰ä»·å€¼ã€‚

## æ ¸å¿ƒæ¦‚å¿µ
1. **å·¥å…·å®šä¹‰**ï¼šåˆ›å»ºå¯ç”±ä»£ç†ç†è§£å’Œè°ƒç”¨çš„åŠŸèƒ½æ¨¡å—ã€‚
2. **å·¥å…·å‘ç°**ï¼šä»£ç†èƒ½å¤Ÿäº†è§£å¯ç”¨å·¥å…·åŠå…¶åŠŸèƒ½ã€‚
3. **å·¥å…·è°ƒç”¨**ï¼šä»£ç†èƒ½å¤Ÿæ­£ç¡®è°ƒç”¨é€‚å½“çš„å·¥å…·ä»¥å®Œæˆä»»åŠ¡ã€‚
4. **ç»“æœå¤„ç†**ï¼šä»£ç†èƒ½å¤Ÿç†è§£å’Œåˆ©ç”¨å·¥å…·è¿”å›çš„ç»“æœã€‚

## å®é™…åº”ç”¨
å·¥å…·ä½¿ç”¨æ¨¡å¼å¹¿æ³›åº”ç”¨äºå„ç§åœºæ™¯ï¼ŒåŒ…æ‹¬ï¼š
- é‡‘èæ•°æ®æŸ¥è¯¢å’Œåˆ†æ
- å¤©æ°”ä¿¡æ¯æ£€ç´¢
- æœç´¢å¼•æ“é›†æˆ
- æ•°æ®åº“æ“ä½œ
- APIé›†æˆ
- è®¡ç®—å’Œè½¬æ¢ä»»åŠ¡

## ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šä½¿ç”¨CrewAIçš„å‡½æ•°è°ƒç”¨

```python
# pip install crewai langchain-openai

import os
from crewai import Agent, Task, Crew
from crewai.tools import tool
import logging

# --- æœ€ä½³å®è·µï¼šé…ç½®æ—¥å¿— ---
# åŸºæœ¬æ—¥å¿—è®¾ç½®æœ‰åŠ©äºè°ƒè¯•å’Œè·Ÿè¸ªä»£ç†çš„æ‰§è¡Œ
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# --- è®¾ç½®APIå¯†é’¥ ---
# å¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œå»ºè®®ä½¿ç”¨æ›´å®‰å…¨çš„å¯†é’¥ç®¡ç†æ–¹æ³•
# å¦‚è¿è¡Œæ—¶åŠ è½½çš„ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†å™¨
#
# è®¾ç½®æ‰€é€‰LLMæä¾›å•†çš„ç¯å¢ƒå˜é‡ï¼ˆå¦‚OPENAI_API_KEYï¼‰
# os.environ["OPENAI_API_KEY"] = "YOUR_API_KEY"
# os.environ["OPENAI_MODEL_NAME"] = "gpt-4o"


# --- 1. é‡æ„å·¥å…·ï¼šè¿”å›å¹²å‡€æ•°æ® ---
# è¯¥å·¥å…·ç°åœ¨è¿”å›åŸå§‹æ•°æ®ï¼ˆæµ®ç‚¹æ•°ï¼‰æˆ–å¼•å‘æ ‡å‡†Pythoné”™è¯¯
# è¿™ä½¿å…¶æ›´å…·å¯é‡ç”¨æ€§ï¼Œå¹¶å¼ºåˆ¶ä»£ç†æ­£ç¡®å¤„ç†ç»“æœ
@tool("è‚¡ç¥¨ä»·æ ¼æŸ¥è¯¢å·¥å…·")
def get_stock_price(ticker: str) -> float:
    """
    è·å–ç»™å®šè‚¡ç¥¨ä»£ç çš„æœ€æ–°æ¨¡æ‹Ÿè‚¡ç¥¨ä»·æ ¼ã€‚
    è¿”å›ä½œä¸ºæµ®ç‚¹æ•°çš„ä»·æ ¼ã€‚å¦‚æœæ‰¾ä¸åˆ°è‚¡ç¥¨ä»£ç ï¼Œå°†å¼•å‘ValueErrorã€‚
    """
    logging.info(f"å·¥å…·è°ƒç”¨: get_stock_price æŸ¥è¯¢è‚¡ç¥¨ä»£ç  '{ticker}'")
    simulated_prices = {
        "AAPL": 178.15,
        "GOOGL": 1750.30,
        "MSFT": 425.50,
    }
    price = simulated_prices.get(ticker.upper())

    if price is not None:
        return price
    else:
        # å¼•å‘ç‰¹å®šé”™è¯¯æ¯”è¿”å›å­—ç¬¦ä¸²æ›´å¥½
        # ä»£ç†é…å¤‡å¤„ç†å¼‚å¸¸çš„èƒ½åŠ›ï¼Œå¹¶å¯å†³å®šä¸‹ä¸€æ­¥æ“ä½œ
        raise ValueError(f"æœªæ‰¾åˆ°è‚¡ç¥¨ä»£ç  '{ticker.upper()}' çš„æ¨¡æ‹Ÿä»·æ ¼ã€‚")


# --- 2. å®šä¹‰ä»£ç† ---
# ä»£ç†å®šä¹‰ä¿æŒä¸å˜ï¼Œä½†ç°åœ¨å°†åˆ©ç”¨æ”¹è¿›çš„å·¥å…·
financial_analyst_agent = Agent(
  role='é«˜çº§é‡‘èåˆ†æå¸ˆ',
  goal='ä½¿ç”¨æä¾›çš„å·¥å…·åˆ†æè‚¡ç¥¨æ•°æ®å¹¶æŠ¥å‘Šå…³é”®ä»·æ ¼',
  backstory="æ‚¨æ˜¯ç»éªŒä¸°å¯Œçš„é‡‘èåˆ†æå¸ˆï¼Œæ“…é•¿ä½¿ç”¨æ•°æ®æºæŸ¥æ‰¾è‚¡ç¥¨ä¿¡æ¯ã€‚æ‚¨æä¾›æ¸…æ™°ã€ç›´æ¥çš„ç­”æ¡ˆã€‚",
  verbose=True,
  tools=[get_stock_price],
  # å…è®¸å§”æ‰˜å¯èƒ½æœ‰ç”¨ï¼Œä½†å¯¹äºæ­¤ç®€å•ä»»åŠ¡å¹¶éå¿…è¦
  allow_delegation=False,
)

# --- 3. ç²¾ç‚¼ä»»åŠ¡ï¼šæ›´æ¸…æ™°çš„è¯´æ˜å’Œé”™è¯¯å¤„ç† ---
# ä»»åŠ¡æè¿°æ›´å…·ä½“ï¼ŒæŒ‡å¯¼ä»£ç†å¦‚ä½•å“åº”
# æˆåŠŸæ•°æ®æ£€ç´¢å’Œæ½œåœ¨é”™è¯¯çš„å¤„ç†
analyze_aapl_task = Task(
  description=(
      "è‹¹æœå…¬å¸ï¼ˆè‚¡ç¥¨ä»£ç ï¼šAAPLï¼‰çš„å½“å‰æ¨¡æ‹Ÿè‚¡ç¥¨ä»·æ ¼æ˜¯å¤šå°‘ï¼Ÿ "
      "ä½¿ç”¨'è‚¡ç¥¨ä»·æ ¼æŸ¥è¯¢å·¥å…·'æŸ¥æ‰¾ã€‚ "
      "å¦‚æœæ‰¾ä¸åˆ°è‚¡ç¥¨ä»£ç ï¼Œæ‚¨å¿…é¡»æŠ¥å‘Šæ— æ³•æ£€ç´¢ä»·æ ¼ã€‚"
  ),
  expected_output=(
      "ä¸€å¥å£°æ˜AAPLæ¨¡æ‹Ÿè‚¡ç¥¨ä»·æ ¼çš„æ¸…æ™°å¥å­ã€‚ "
      "ä¾‹å¦‚ï¼š'AAPLçš„æ¨¡æ‹Ÿè‚¡ç¥¨ä»·æ ¼æ˜¯$178.15ã€‚' "
      "å¦‚æœæ‰¾ä¸åˆ°ä»·æ ¼ï¼Œåˆ™æ˜ç¡®è¯´æ˜ã€‚"
  ),
  agent=financial_analyst_agent,
)

# --- 4. ç»„å»ºå›¢é˜Ÿ ---
# å›¢é˜Ÿåè°ƒä»£ç†å’Œä»»åŠ¡å¦‚ä½•ååŒå·¥ä½œ
financial_crew = Crew(
  agents=[financial_analyst_agent],
  tasks=[analyze_aapl_task],
  verbose=True # ç”Ÿäº§ç¯å¢ƒä¸­è®¾ä¸ºFalseä»¥å‡å°‘è¯¦ç»†æ—¥å¿—
)

# --- 5. åœ¨ä¸»æ‰§è¡Œå—ä¸­è¿è¡Œå›¢é˜Ÿ ---
# ä½¿ç”¨__name__ == "__main__":å—æ˜¯æ ‡å‡†Pythonæœ€ä½³å®è·µ
def main():
    """è¿è¡Œå›¢é˜Ÿçš„ä¸»å‡½æ•°"""
    # åœ¨å¼€å§‹å‰æ£€æŸ¥APIå¯†é’¥ä»¥é¿å…è¿è¡Œæ—¶é”™è¯¯
    if not os.environ.get("OPENAI_API_KEY"):
        print("é”™è¯¯ï¼šæœªè®¾ç½®OPENAI_API_KEYç¯å¢ƒå˜é‡ã€‚")
        print("è¯·åœ¨è¿è¡Œè„šæœ¬å‰è®¾ç½®ã€‚")
        return

    print("\n## å¯åŠ¨é‡‘èå›¢é˜Ÿ...")
    print("---------------------------------")

    # kickoffæ–¹æ³•å¼€å§‹æ‰§è¡Œ
    result = financial_crew.kickoff()

    print("\n---------------------------------")
    print("## å›¢é˜Ÿæ‰§è¡Œå®Œæˆã€‚")
    print("\næœ€ç»ˆç»“æœï¼š\n", result)

if __name__ == "__main__":
    main()
```

### ç¤ºä¾‹2ï¼šä½¿ç”¨LangChainçš„å·¥å…·è°ƒç”¨

```python
import os
import asyncio
from typing import List

from langchain_google_genai import ChatGoogleGenerativeAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.tools import tool
from langchain.agents import create_tool_calling_agent, AgentExecutor

# --- é…ç½® ---
# ç¡®ä¿å·²è®¾ç½®GOOGLE_API_KEYç¯å¢ƒå˜é‡
try:
    # éœ€è¦å…·æœ‰å‡½æ•°/å·¥å…·è°ƒç”¨åŠŸèƒ½çš„æ¨¡å‹
    llm = ChatGoogleGenerativeAI(model="gemini-pro", temperature=0)
    print(f"âœ… è¯­è¨€æ¨¡å‹åˆå§‹åŒ–ï¼š{llm.model_name}")
except Exception as e:
    print(f"ğŸ›‘ åˆå§‹åŒ–è¯­è¨€æ¨¡å‹æ—¶å‡ºé”™ï¼š{e}")
    llm = None


# --- å®šä¹‰å·¥å…· ---
@tool
def search_information(query: str) -> str:
    """
    æä¾›å…³äºç»™å®šä¸»é¢˜çš„å®¢è§‚ä¿¡æ¯ã€‚ä½¿ç”¨æ­¤å·¥å…·æŸ¥æ‰¾å¦‚'æ³•å›½çš„é¦–éƒ½æ˜¯ä»€ä¹ˆï¼Ÿ'æˆ–'ä¼¦æ•¦å¤©æ°”å¦‚ä½•ï¼Ÿ'ç­‰é—®é¢˜çš„ç­”æ¡ˆã€‚
    """
    print(f"\n--- ğŸ› ï¸ å·¥å…·è°ƒç”¨ï¼šsearch_information æŸ¥è¯¢ï¼š'{query}' ---")
    # ç”¨é¢„å®šä¹‰ç»“æœçš„å­—å…¸æ¨¡æ‹Ÿæœç´¢å·¥å…·
    simulated_results = {
        "weather in london": "ä¼¦æ•¦ç›®å‰å¤šäº‘ï¼Œæ¸©åº¦ä¸º15Â°Cã€‚",
        "capital of france": "æ³•å›½çš„é¦–éƒ½æ˜¯å·´é»ã€‚",
        "population of earth": "åœ°çƒçš„ä¼°è®¡äººå£çº¦ä¸º80äº¿ã€‚",
        "tallest mountain": "ç ç©†æœ—ç›å³°æ˜¯æµ·å¹³é¢ä»¥ä¸Šçš„æœ€é«˜å³°ã€‚",
        "default": f"æ¨¡æ‹Ÿæœç´¢ç»“æœæŸ¥è¯¢ '{query}'ï¼šæœªæ‰¾åˆ°ç‰¹å®šä¿¡æ¯ï¼Œä½†ä¸»é¢˜ä¼¼ä¹æœ‰è¶£ã€‚"
    }
    result = simulated_results.get(query.lower(), simulated_results["default"])
    print(f"--- å·¥å…·ç»“æœï¼š{result} ---")
    return result

tools = [search_information]


# --- åˆ›å»ºå·¥å…·è°ƒç”¨ä»£ç† ---
if llm:
    # æ­¤æç¤ºæ¨¡æ¿éœ€è¦å ä½ç¬¦'agent_scratchpad'ç”¨äºä»£ç†çš„å†…éƒ¨æ­¥éª¤
    agent_prompt = ChatPromptTemplate.from_messages([
        ("system", "æ‚¨æ˜¯æœ‰åŠ©çš„åŠ©æ‰‹ã€‚"),
        ("human", "{input}"),
        ("placeholder", "{agent_scratchpad}"),
    ])

    # åˆ›å»ºä»£ç†ï¼Œå°†LLMã€å·¥å…·å’Œæç¤ºç»‘å®šåœ¨ä¸€èµ·
    agent = create_tool_calling_agent(llm, tools, agent_prompt)

    # AgentExecutoræ˜¯è°ƒç”¨ä»£ç†å¹¶æ‰§è¡Œæ‰€é€‰å·¥å…·çš„è¿è¡Œæ—¶
    # 'tools'å‚æ•°åœ¨æ­¤å¤„ä¸éœ€è¦ï¼Œå› ä¸ºå®ƒä»¬å·²ç»‘å®šåˆ°ä»£ç†
    agent_executor = AgentExecutor(agent=agent, verbose=True)


    async def run_agent_with_tool(query: str):
        """ä½¿ç”¨æŸ¥è¯¢è°ƒç”¨ä»£ç†æ‰§è¡Œå™¨å¹¶æ‰“å°æœ€ç»ˆå“åº”"""
        print(f"\n--- ğŸƒ è¿è¡Œä»£ç†æŸ¥è¯¢ï¼š'{query}' ---")
        try:
            response = await agent_executor.ainvoke({"input": query})
            print("\n--- âœ… ä»£ç†æœ€ç»ˆå“åº” ---")
            print(response["output"])
        except Exception as e:
            print(f"\nğŸ›‘ ä»£ç†æ‰§è¡ŒæœŸé—´å‘ç”Ÿé”™è¯¯ï¼š{e}")

    async def main():
        """åŒæ—¶è¿è¡Œæ‰€æœ‰ä»£ç†æŸ¥è¯¢"""
        tasks = [
            run_agent_with_tool("æ³•å›½çš„é¦–éƒ½æ˜¯ä»€ä¹ˆï¼Ÿ"),
            run_agent_with_tool("ä¼¦æ•¦å¤©æ°”å¦‚ä½•ï¼Ÿ"),
            run_agent_with_tool("å‘Šè¯‰æˆ‘ä¸€äº›å…³äºç‹—çš„ä¿¡æ¯ã€‚") # åº”è§¦å‘é»˜è®¤å·¥å…·å“åº”
        ]
        await asyncio.gather(*tasks)

    if __name__ == "__main__":
        # åœ¨å•ä¸ªäº‹ä»¶å¾ªç¯ä¸­è¿è¡Œæ‰€æœ‰å¼‚æ­¥ä»»åŠ¡
        asyncio.run(main())

else:
    print("\nç”±äºLLMåˆå§‹åŒ–å¤±è´¥ï¼Œè·³è¿‡ä»£ç†æ‰§è¡Œã€‚")
```

## æ€»ç»“
å·¥å…·ä½¿ç”¨æ¨¡å¼æ˜¯æ„å»ºåŠŸèƒ½å¼ºå¤§çš„AIä»£ç†çš„å…³é”®æŠ€æœ¯ã€‚å®ƒé€šè¿‡å…è®¸ä»£ç†ä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’ï¼Œæ˜¾è‘—æ‰©å±•äº†ä»£ç†çš„èƒ½åŠ›ã€‚é€šè¿‡å®šä¹‰æ¸…æ™°çš„å·¥å…·æ¥å£å¹¶å®æ–½é€‚å½“çš„é”™è¯¯å¤„ç†ï¼Œä»£ç†å¯ä»¥å®‰å…¨ã€æœ‰æ•ˆåœ°æ‰©å±•å…¶åŠŸèƒ½ï¼Œæ‰§è¡Œä»…é å…¶å†…éƒ¨èƒ½åŠ›æ— æ³•å®Œæˆçš„ä»»åŠ¡ã€‚è¿™ç§æ¨¡å¼æ˜¯æ„å»ºå¤æ‚å¤šæ¨¡æ€AIç³»ç»Ÿçš„åŸºç¡€ã€‚